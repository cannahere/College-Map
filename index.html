<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="google-site-verification" content="XLI_3QT03lSkcCEmteQWtQeDviYsA07lmIbGu_5GKCc" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Branding and Icons -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="site.webmanifest">

  <!-- SEO Meta Tags -->
  <title>U.S. College Map | Explore Colleges by Location, Type, and State</title>
  <link rel="canonical" href="https://uscollegemap.org/">
  <meta name="description" content="Use the U.S. College Map to explore accredited universities and colleges across America by location, type, and state. Filter, search, and find the best match for you.">
  <meta name="keywords" content="US college map, college finder, university map, colleges by location, college search USA, higher education map, universities by state">
  <meta name="author" content="U.S. College Map">

  <!-- Open Graph (Social Media Preview) -->
  <meta property="og:title" content="U.S. College Map | Explore Colleges by Location, Type, and State">
  <meta property="og:description" content="Find and explore U.S. colleges on an interactive map — filter by state, type, and proximity to your home.">
  <meta property="og:image" content="https://uscollegemap.org/USCollegeMap_Logo.png">
  <meta property="og:url" content="https://uscollegemap.org/">
  <meta property="og:type" content="website">

  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="U.S. College Map">
  <meta name="twitter:description" content="Explore accredited U.S. colleges and universities on an interactive map.">
  <meta name="twitter:image" content="https://uscollegemap.org/USCollegeMap_Logo.png">

  <!-- Resource Hints for Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://nominatim.openstreetmap.org">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {margin:0;font-family:Inter,system-ui,sans-serif;background:#fff;color:#0f172a}
    .container {max-width:1100px;margin:0 auto;padding:16px}
    header.app-header {position:sticky;top:0;background:#fff;z-index:10;border-bottom:1px solid #e2e8f0;box-shadow:0 10px 25px rgba(15,23,42,.08)}
    .app-header {display:flex;align-items:center;justify-content:flex-start;gap:16px;padding:16px 40px;background:#fff;border-bottom:1px solid #e5e7eb;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
    .site-logo {height:70px;transition:all 0.3s ease;}
    @media (max-width:700px){
      .app-header{flex-direction:column;align-items:center;text-align:center}
      .site-logo{height:56px;margin-bottom:6px;}
    }
    .controls {display:flex;flex-direction:column;gap:12px;padding:14px 16px 16px;border-top:1px solid #e5e7eb;background:#fff}
    .row {display:flex;gap:12px;justify-content:space-between}
    .row>.pill {flex:1}
    .pill {display:flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid #e2e8f0;padding:6px 10px;border-radius:12px;font-size:12px}
    .pill label {color:#475569;font-weight:600;font-size:12px;min-width:60px}
    .pill input,.pill select,.pill button {border:1px solid #e2e8f0;border-radius:10px;padding:8px 10px;background:#fff;color:#0f172a;font-size:14px;flex:1}
    .pill button {background:#2563eb;color:#fff;border:none;font-weight:600;cursor:pointer;flex:0}
    #map {height:calc(100vh - 210px);background:#e5e7eb;border-top:1px solid #e2e8f0}
    .legend {position:absolute;bottom:14px;left:14px;background:#fff;padding:8px 10px;border-radius:12px;border:1px solid #e2e8f0;font-size:12px;box-shadow:0 10px 25px rgba(15,23,42,.08);color:#0f172a}
    .leaflet-tooltip {background:#fff;color:#0f172a;border:1px solid #e2e8f0;border-radius:6px;font-size:12px;font-weight:500;padding:4px 8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .loading {display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 25px rgba(15,23,42,.15);z-index:1000}
    .loading.active {display:block}
    .error {display:none;background:#fee;color:#c33;padding:12px;border-radius:8px;margin:12px;border:1px solid #fcc}
    .error.active {display:block}
    .radius-circle {stroke:#2563eb;stroke-width:2;stroke-dasharray:5,5;fill:none;opacity:0.5;pointer-events:none}
  </style>
</head>
<body>
<header class="app-header">
  <img src="USCollegeMap_Logo.png" alt="U.S. College Map logo" class="site-logo">
</header>

<div class="container controls">
  <div class="row">
    <div class="pill"><label for="type">Type</label><select id="type"><option value="">Any</option></select></div>
    <div class="pill"><label for="region">Region</label><select id="region"><option value="">All</option></select></div>
    <div class="pill"><label for="state">State</label><select id="state"><option value="">All</option></select></div>
    <div class="pill"><label for="search">Search</label><input id="search" placeholder="Search by college name..." /></div>
  </div>
  <div class="row">
    <div class="pill"><label for="address">Address</label><input id="address" placeholder="Enter your home address" /><button id="geocodeBtn">Set</button></div>
    <div class="pill"><label for="radius">Radius</label><input id="radius" type="number" min="0" step="10" value="50" style="width:90px"><select id="units"><option value="mi" selected>mi</option><option value="km">km</option></select><button id="clearRadius" style="background:transparent;color:#0f172a;border:1px solid #e2e8f0;">Clear</button></div>
  </div>
</div>

<div id="map"></div>
<div class="legend" id="legend">Showing <span id="count">0</span> schools</div>
<div class="loading" id="loading">Loading colleges data...</div>
<div class="error" id="error"></div>

<script>
const localMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
const DATA_URL = localMode ? 'colleges_usa_2024.csv' : 'https://uscollegemap.org/colleges_usa_2024.csv';

// Cache DOM references for performance
const elements = {
  state: document.getElementById('state'),
  region: document.getElementById('region'),
  type: document.getElementById('type'),
  search: document.getElementById('search'),
  address: document.getElementById('address'),
  radius: document.getElementById('radius'),
  units: document.getElementById('units'),
  count: document.getElementById('count'),
  loading: document.getElementById('loading'),
  error: document.getElementById('error'),
  geocodeBtn: document.getElementById('geocodeBtn'),
  clearRadius: document.getElementById('clearRadius')
};

const americasBounds = L.latLngBounds([[-60,-180],[85,-30]]);
const map = L.map('map',{maxBounds:americasBounds,maxBoundsViscosity:1}).setView([39.5,-98.35],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors',attributionControl:true}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);

const homeLayer = L.layerGroup().addTo(map);
const radiusLayer = L.layerGroup().addTo(map);
let colleges = [], home = null;

const TYPE_ORDER = ["Ivy League","Elite Private Universities","Public Flagship Universities","Private Liberal Arts Colleges","STEM / Technology Institutes","Business / Arts / Specialty Schools","Health & Medical Colleges","Faith-Based","Public Regional Universities","Community Colleges","Online / For-Profit"];

// Region mapping for better performance
const REGION_MAP = {
  'Northeast': ['ME','NH','VT','MA','RI','CT','NY','NJ','PA'],
  'Midwest': ['OH','MI','IN','IL','WI','MN','IA','MO','ND','SD','NE','KS'],
  'South': ['DE','MD','DC','VA','WV','NC','SC','GA','FL','KY','TN','AL','MS','AR','LA','TX','OK'],
  'West': ['MT','ID','WY','CO','NM','AZ','UT','NV','CA','OR','WA','HI','AK'],
  'Territories': ['PR','GU','VI','AS','MP']
};

// Calculate distance between two coordinates (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2, unit = 'mi') {
  const R = unit === 'mi' ? 3959 : 6371; // Earth radius in miles or km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Debounce function for search input
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showError(message) {
  elements.error.textContent = message;
  elements.error.classList.add('active');
  setTimeout(() => elements.error.classList.remove('active'), 5000);
}

function render(){
  // Check if colleges data is loaded
  if (!colleges || colleges.length === 0) {
    console.log('No colleges data available yet');
    elements.count.textContent = '0';
    return;
  }
  
  markersLayer.clearLayers();
  radiusLayer.clearLayers();
  
  const stateVal = elements.state.value;
  const regionVal = elements.region.value;
  const typeVal = elements.type.value;
  const searchVal = elements.search.value.toLowerCase().trim();
  const radiusVal = parseFloat(elements.radius.value) || 0;
  const unitsVal = elements.units.value;

  let filtered = colleges.filter(c => {
    // Region filter
    const regionMatch = !regionVal || (REGION_MAP[regionVal] || []).includes(c.state);
    if (!regionMatch) return false;
    
    // State filter
    if (stateVal && c.state !== stateVal) return false;
    
    // Type filter
    if (typeVal && (c.type || c.tier) !== typeVal) return false;
    
    // Search filter
    if (searchVal && !c.name.toLowerCase().includes(searchVal)) return false;
    
    // Radius filter (if home location is set)
    if (home && radiusVal > 0) {
      const distance = calculateDistance(home.lat, home.lon, c.lat, c.lon, unitsVal);
      if (distance > radiusVal) return false;
    }
    
    return true;
  });

  // Draw radius circle if home and radius are set
  if (home && radiusVal > 0) {
    const radiusMeters = radiusVal * (unitsVal === 'mi' ? 1609.34 : 1000);
    L.circle([home.lat, home.lon], {
      radius: radiusMeters,
      color: '#2563eb',
      fillColor: '#2563eb',
      fillOpacity: 0.1,
      weight: 2,
      dashArray: '5, 5'
    }).addTo(radiusLayer);
  }

  console.log(`Rendering ${filtered.length} colleges`);
  
  filtered.forEach(c => {
    try {
      // Validate coordinates
      if (isNaN(c.lat) || isNaN(c.lon) || c.lat === 0 || c.lon === 0) {
        console.warn(`Invalid coordinates for ${c.name}:`, c.lat, c.lon);
        return;
      }
      
      const tuition = c.tuition ? (c.tuition.toString().includes('$') ? c.tuition : `$${Number(c.tuition).toLocaleString()}`) : 'N/A';
      const acceptance = c.acceptance ? (c.acceptance.toString().includes('%') ? c.acceptance : `${parseFloat(c.acceptance).toFixed(1)}%`) : 'N/A';
      
      // Calculate distance if home is set
      let distanceText = '';
      if (home) {
        const distance = calculateDistance(home.lat, home.lon, c.lat, c.lon, unitsVal);
        distanceText = `<br>Distance: ${distance.toFixed(1)} ${unitsVal}`;
      }
      
      const popupContent = `
        <div style="font-size:12px;line-height:1.4">
          <b>${c.name}</b><br>
          ${c.state} · ${(c.type||'Unknown')}${distanceText}<br>
          ${c.control ? c.control + ' | ' : ''}Acceptance Rate: ${acceptance}<br>
          Enrollment: ${c.enrollment || 'N/A'}<br>
          Tuition: ${tuition}<br>
          ${c.url ? `<a href="https://${c.url.replace(/^https?:\/\//,'')}" target="_blank">${c.url}</a>` : ''}
        </div>`;

    L.circleMarker([c.lat, c.lon], {radius: 5, color: '#2563eb', weight: 2, fillOpacity: 0.7})
      .bindTooltip(c.name, {permanent: false, direction: 'top'})
      .bindPopup(popupContent)
      .addTo(markersLayer);
    } catch (e) {
      console.error(`Error creating marker for ${c.name}:`, e);
    }
  });

  elements.count.textContent = filtered.length.toLocaleString();
  console.log(`Added ${filtered.length} markers to map`);
}

function refreshDropdown(id, values, placeholder) {
  const select = document.getElementById(id);
  select.innerHTML = `<option value="">${placeholder}</option>` + values.map(v => `<option>${v}</option>`).join('');
}

function loadCSV(url){
  elements.loading.classList.add('active');
  
  // Try to load from cache first
  const cacheKey = 'colleges_data_cache';
  const cacheTime = 'colleges_data_time';
  const cacheExpiry = 24 * 60 * 60 * 1000; // 24 hours
  
  try {
    const cachedData = localStorage.getItem(cacheKey);
    const cachedTime = localStorage.getItem(cacheTime);
    
    if (cachedData && cachedTime && Date.now() - parseInt(cachedTime) < cacheExpiry) {
      const data = JSON.parse(cachedData);
      processCollegesData(data);
      elements.loading.classList.remove('active');
      return;
    }
  } catch (e) {
    // Cache read failed, proceed with download
  }
  
  Papa.parse(url, {
    header: true,
    dynamicTyping: true,
    download: true,
    complete: (results) => {
      elements.loading.classList.remove('active');
      
      console.log('CSV parsing complete. Rows:', results.data?.length);
      
      if (results.errors && results.errors.length > 0) {
        console.warn('CSV parsing errors:', results.errors);
      }
      
      if (!results.data || results.data.length === 0) {
        showError('Failed to load colleges data. Please refresh the page.');
        console.error('No data in CSV results');
        return;
      }
      
      // Cache the data
      try {
        localStorage.setItem(cacheKey, JSON.stringify(results.data));
        localStorage.setItem(cacheTime, Date.now().toString());
        console.log('Data cached successfully');
      } catch (e) {
        console.warn('Cache write failed:', e);
      }
      
      processCollegesData(results.data);
    },
    error: (error) => {
      elements.loading.classList.remove('active');
      showError('Error loading colleges data: ' + (error.message || 'Unknown error'));
      console.error('CSV load error:', error);
    }
  });
}

function processCollegesData(data) {
  colleges = data.filter(r => r.name && r.lat && r.lon).map(r => ({
    name: r.name,
    lat: +r.lat,
    lon: +r.lon,
    state: (r.state || '').toUpperCase(),
    type: r.type || 'Unknown',
    control: r.control || '',
    acceptance: r.acceptance || '',
    enrollment: r.enrollment || '',
    tuition: r.tuition || '',
    url: r.url || ''
  }));
  
  console.log(`Loaded ${colleges.length} colleges`);
  
  if (colleges.length === 0) {
    showError('No college data found. Please check the CSV file.');
    return;
  }
  
  const states = [...new Set(colleges.map(c => c.state))].sort();
  const types = [...new Set(colleges.map(c => c.type))].filter(Boolean);
  const ranked = [...TYPE_ORDER.filter(t => types.includes(t))];
  const leftovers = types.filter(t => !TYPE_ORDER.includes(t)).sort();
  const orderedTypes = ranked.concat(leftovers);
  
  refreshDropdown('state', states, 'All');
  refreshDropdown('type', orderedTypes, 'Any');
  refreshDropdown('region', ['Northeast', 'Midwest', 'South', 'West', 'Territories'], 'All');
  
  render();
}

function geocodeAddress(address){
  if(!address) {
    showError('Please enter an address');
    return;
  }
  
  elements.loading.classList.add('active');
  
  // Rate limiting: Nominatim requires a User-Agent and has strict rate limits
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`, {
    headers: {
      'User-Agent': 'USCollegeMap/1.0'
    }
  })
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      elements.loading.classList.remove('active');
      
      if (data && data[0]) {
        const lat = +data[0].lat;
        const lon = +data[0].lon;
        home = { lat, lon };
        homeLayer.clearLayers();
        radiusLayer.clearLayers();
        L.marker([lat, lon], { icon: L.icon({
          iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="25" height="35" viewBox="0 0 12 18"><path fill="#dc2626" d="M6 0C2.69 0 0 2.69 0 6c0 5 6 12 6 12s6-7 6-12c0-3.31-2.69-6-6-6zm0 8.5c-1.38 0-2.5-1.12-2.5-2.5S4.62 3.5 6 3.5 8.5 4.62 8.5 6 7.38 8.5 6 8.5z"/></svg>'),
          iconSize: [25, 35],
          iconAnchor: [12, 35],
          popupAnchor: [0, -35]
        })})
          .bindPopup("Home location")
          .addTo(homeLayer)
          .openPopup();
        map.setView([lat, lon], 8);
        render(); // Re-render to apply radius filter
      } else {
        showError('Address not found. Please try a different address.');
      }
    })
    .catch(error => {
      elements.loading.classList.remove('active');
      showError('Error geocoding address: ' + (error.message || 'Please try again later'));
      console.error('Geocoding error:', error);
    });
}

// Initialize dropdowns immediately
// Region dropdown (doesn't depend on CSV)
refreshDropdown('region', ['Northeast', 'Midwest', 'South', 'West', 'Territories'], 'All');

// Type dropdown (initialize with common types, will be updated when CSV loads)
try {
  refreshDropdown('type', TYPE_ORDER.filter(Boolean), 'Any');
} catch (e) {
  console.error('Error initializing type dropdown:', e);
  // Fallback: ensure dropdown at least exists
  const typeSelect = document.getElementById('type');
  if (typeSelect) {
    typeSelect.innerHTML = '<option value="">Any</option>';
  }
}

// Event listeners
elements.geocodeBtn.onclick = () => geocodeAddress(elements.address.value);
elements.address.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') geocodeAddress(elements.address.value);
});

elements.clearRadius.onclick = () => {
  elements.radius.value = '50';
  home = null;
  homeLayer.clearLayers();
  radiusLayer.clearLayers();
  map.setView([39.5, -98.35], 4);
  render();
};

['state', 'region', 'type', 'radius', 'units'].forEach(id => {
  document.getElementById(id).addEventListener('change', render);
});

// Debounced search input
elements.search.addEventListener('input', debounce(render, 300));

// Check if running from file:// protocol (won't work due to CORS)
if (window.location.protocol === 'file:') {
  showError('Please use a web server to test this page. CSV files cannot load from file:// protocol. Use: python3 -m http.server 8000');
  console.error('Cannot load CSV from file:// protocol due to CORS restrictions');
} else {
  loadCSV(DATA_URL);
}
</script>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E2KP0JHTMC"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-E2KP0JHTMC');
</script>

</body>
</html>
