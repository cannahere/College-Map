<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="google-site-verification" content="XLI_3QT03lSkcCEmteQWtQeDviYsA07lmIbGu_5GKCc" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Branding and Icons -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="site.webmanifest">

  <!-- SEO Meta Tags -->
  <title>U.S. College Map | Explore Colleges by Location, Type, and State</title>
  <link rel="canonical" href="https://uscollegemap.org/">
  <meta name="description" content="Use the U.S. College Map to explore accredited universities and colleges across America by location, type, and state. Filter, search, and find the best match for you.">
  <meta name="keywords" content="US college map, college finder, university map, colleges by location, college search USA, higher education map, universities by state">
  <meta name="author" content="U.S. College Map">

  <!-- Open Graph (Social Media Preview) -->
  <meta property="og:title" content="U.S. College Map | Explore Colleges by Location, Type, and State">
  <meta property="og:description" content="Find and explore U.S. colleges on an interactive map — filter by state, type, and proximity to your home.">
  <meta property="og:image" content="https://uscollegemap.org/USCollegeMap_Logo.png">
  <meta property="og:url" content="https://uscollegemap.org/">
  <meta property="og:type" content="website">

  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="U.S. College Map">
  <meta name="twitter:description" content="Explore accredited U.S. colleges and universities on an interactive map.">
  <meta name="twitter:image" content="https://uscollegemap.org/USCollegeMap_Logo.png">

  <!-- Resource Hints for Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://nominatim.openstreetmap.org">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {margin:0;font-family:Inter,system-ui,sans-serif;background:#fff;color:#0f172a}
    .container {max-width:1100px;margin:0 auto;padding:16px}
    header.app-header {position:sticky;top:0;background:#fff;z-index:10;border-bottom:1px solid #e2e8f0;box-shadow:0 10px 25px rgba(15,23,42,.08)}
    .app-header {display:flex;align-items:center;justify-content:flex-start;gap:16px;padding:16px 40px;background:#fff;border-bottom:1px solid #e5e7eb;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
    .site-logo {height:70px;transition:all 0.3s ease;}
    @media (max-width:700px){
      .app-header{flex-direction:column;align-items:center;text-align:center}
      .site-logo{height:56px;margin-bottom:6px;}
    }
    .controls {display:flex;flex-direction:column;gap:12px;padding:14px 16px 16px;border-top:1px solid #e5e7eb;background:#fff}
    .row {display:flex;gap:12px;justify-content:space-between}
    .row>.pill {flex:1}
    .pill {display:flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid #e2e8f0;padding:6px 10px;border-radius:12px;font-size:12px}
    .pill label {color:#475569;font-weight:600;font-size:12px;min-width:60px}
    .pill input,.pill select,.pill button {border:1px solid #e2e8f0;border-radius:10px;padding:8px 10px;background:#fff;color:#0f172a;font-size:14px;flex:1;transition:border-color 0.2s,box-shadow 0.2s}
    .pill input:focus {outline:none;border-color:#4285f4;box-shadow:0 0 0 1px #4285f4}
    .pill button {background:#2563eb;color:#fff;border:none;font-weight:600;cursor:pointer;flex:0}
    #map {height:calc(100vh - 210px);background:#e5e7eb;border-top:1px solid #e2e8f0}
    .legend {position:absolute;bottom:14px;left:14px;background:#fff;padding:8px 10px;border-radius:12px;border:1px solid #e2e8f0;font-size:12px;box-shadow:0 10px 25px rgba(15,23,42,.08);color:#0f172a}
    .leaflet-tooltip {background:#fff;color:#0f172a;border:1px solid #e2e8f0;border-radius:6px;font-size:12px;font-weight:500;padding:4px 8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .loading {display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 25px rgba(15,23,42,.15);z-index:1000}
    .loading.active {display:block}
    .error {display:none;background:#fee;color:#c33;padding:12px;border-radius:8px;margin:12px;border:1px solid #fcc}
    .error.active {display:block}
    .radius-circle {stroke:#2563eb;stroke-width:2;stroke-dasharray:5,5;fill:none;opacity:0.5;pointer-events:none}
    .address-autocomplete {position:relative}
    .autocomplete-suggestions {display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:none;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1),0 8px 24px rgba(0,0,0,0.12);max-height:400px;overflow-y:auto;overflow-x:hidden;z-index:1000;margin-top:0}
    .autocomplete-suggestions.active {display:block;animation:fadeIn 0.15s ease-out}
    @keyframes fadeIn {from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:translateY(0)}}
    .autocomplete-item {padding:0;cursor:pointer;border-bottom:none;font-size:14px;transition:background-color 0.1s;min-height:48px;display:flex;flex-direction:row;align-items:center;position:relative;width:100%}
    .autocomplete-item:not(:last-child)::after {content:'';position:absolute;bottom:0;left:56px;right:0;height:1px;background:#f1f5f9}
    .autocomplete-item:hover,.autocomplete-item.highlighted {background-color:#f8f9fa}
    .autocomplete-item:focus {outline:2px solid #4285f4;outline-offset:-2px;background-color:#f8f9fa}
    .autocomplete-item-icon {width:40px;height:40px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-left:8px}
    .autocomplete-item-icon svg {width:20px;height:20px;fill:#5f6368;display:block}
    .autocomplete-item.highlighted .autocomplete-item-icon svg,.autocomplete-item:hover .autocomplete-item-icon svg {fill:#4285f4}
    .autocomplete-item-content {flex:1;padding:12px 8px 12px 0;min-width:0;display:flex;flex-direction:column;justify-content:center}
    .autocomplete-item .address-name {font-weight:400;color:#202124;margin-bottom:2px;font-size:15px;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .autocomplete-item .address-name strong {font-weight:500;color:#202124}
    .autocomplete-item.highlighted .address-name,.autocomplete-item:hover .address-name {color:#1a73e8}
    .autocomplete-item.highlighted .address-name strong,.autocomplete-item:hover .address-name strong {color:#1a73e8;font-weight:500}
    .autocomplete-item .address-details {font-size:13px;color:#5f6368;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .autocomplete-loading {padding:16px;text-align:center;color:#5f6368;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px}
    .autocomplete-loading::before {content:'';width:16px;height:16px;border:2px solid #e0e0e0;border-top-color:#4285f4;border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin {to{transform:rotate(360deg)}}
    .autocomplete-empty {padding:24px;text-align:center;color:#5f6368;font-size:14px}
    @media (max-width: 700px) {
      .autocomplete-item {min-height:52px}
      .autocomplete-item-icon {width:44px;height:44px;margin-left:12px}
      .autocomplete-item-content {padding:14px 12px 14px 0}
    }
  </style>
</head>
<body>
<header class="app-header">
  <img src="USCollegeMap_Logo.png" alt="U.S. College Map logo" class="site-logo">
</header>

<div class="container controls">
  <div class="row">
    <div class="pill"><label for="type">Type</label><select id="type"><option value="">Any</option></select></div>
    <div class="pill"><label for="region">Region</label><select id="region"><option value="">All</option></select></div>
    <div class="pill"><label for="state">State</label><select id="state"><option value="">All</option></select></div>
    <div class="pill"><label for="search">Search</label><input id="search" placeholder="Search by college name..." /></div>
  </div>
  <div class="row">
    <div class="pill address-autocomplete"><label for="address">Address</label><input id="address" placeholder="Enter your home address" autocomplete="off" aria-autocomplete="list" aria-expanded="false" aria-controls="addressSuggestions" aria-haspopup="listbox" role="combobox" /><button id="geocodeBtn">Set</button><div class="autocomplete-suggestions" id="addressSuggestions" role="listbox" aria-label="Address suggestions"></div></div>
    <div class="pill"><label for="radius">Radius</label><input id="radius" type="number" min="0" step="10" value="50" style="width:90px"><select id="units"><option value="mi" selected>mi</option><option value="km">km</option></select><button id="clearRadius" style="background:transparent;color:#0f172a;border:1px solid #e2e8f0;">Clear</button></div>
  </div>
</div>

<div id="map"></div>
<div class="legend" id="legend">Showing <span id="count">0</span> schools</div>
<div class="loading" id="loading">Loading colleges data...</div>
<div class="error" id="error"></div>

<script>
const localMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
const DATA_URL = localMode ? 'colleges_usa_2024.csv' : 'https://uscollegemap.org/colleges_usa_2024.csv';

// Cache DOM references for performance
const elements = {
  state: document.getElementById('state'),
  region: document.getElementById('region'),
  type: document.getElementById('type'),
  search: document.getElementById('search'),
  address: document.getElementById('address'),
  radius: document.getElementById('radius'),
  units: document.getElementById('units'),
  count: document.getElementById('count'),
  loading: document.getElementById('loading'),
  error: document.getElementById('error'),
  geocodeBtn: document.getElementById('geocodeBtn'),
  clearRadius: document.getElementById('clearRadius'),
  addressSuggestions: document.getElementById('addressSuggestions')
};

let addressAutocomplete = {
  suggestions: [],
  selectedIndex: -1,
  isOpen: false,
  abortController: null
};

const americasBounds = L.latLngBounds([[-60,-180],[85,-30]]);
const map = L.map('map',{maxBounds:americasBounds,maxBoundsViscosity:1}).setView([39.5,-98.35],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors',attributionControl:true}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);

const homeLayer = L.layerGroup().addTo(map);
const radiusLayer = L.layerGroup().addTo(map);
let colleges = [], home = null;

const TYPE_ORDER = ["Ivy League","Elite Private Universities","Public Flagship Universities","Private Liberal Arts Colleges","STEM / Technology Institutes","Business / Arts / Specialty Schools","Health & Medical Colleges","Faith-Based","Public Regional Universities","Community Colleges","Online / For-Profit"];

// Region mapping for better performance
const REGION_MAP = {
  'Northeast': ['ME','NH','VT','MA','RI','CT','NY','NJ','PA'],
  'Midwest': ['OH','MI','IN','IL','WI','MN','IA','MO','ND','SD','NE','KS'],
  'South': ['DE','MD','DC','VA','WV','NC','SC','GA','FL','KY','TN','AL','MS','AR','LA','TX','OK'],
  'West': ['MT','ID','WY','CO','NM','AZ','UT','NV','CA','OR','WA','HI','AK'],
  'Territories': ['PR','GU','VI','AS','MP']
};

// Calculate distance between two coordinates (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2, unit = 'mi') {
  const R = unit === 'mi' ? 3959 : 6371; // Earth radius in miles or km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Debounce function for search input
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showError(message) {
  elements.error.textContent = message;
  elements.error.classList.add('active');
  setTimeout(() => elements.error.classList.remove('active'), 5000);
}

function render(){
  // Check if colleges data is loaded
  if (!colleges || colleges.length === 0) {
    console.log('No colleges data available yet');
    elements.count.textContent = '0';
    return;
  }
  
  markersLayer.clearLayers();
  radiusLayer.clearLayers();
  
  const stateVal = elements.state.value;
  const regionVal = elements.region.value;
  const typeVal = elements.type.value;
  const searchVal = elements.search.value.toLowerCase().trim();
  const radiusVal = parseFloat(elements.radius.value) || 0;
  const unitsVal = elements.units.value;

  let filtered = colleges.filter(c => {
    // Region filter
    const regionMatch = !regionVal || (REGION_MAP[regionVal] || []).includes(c.state);
    if (!regionMatch) return false;
    
    // State filter
    if (stateVal && c.state !== stateVal) return false;
    
    // Type filter
    if (typeVal && (c.type || c.tier) !== typeVal) return false;
    
    // Search filter
    if (searchVal && !c.name.toLowerCase().includes(searchVal)) return false;
    
    // Radius filter (if home location is set)
    if (home && radiusVal > 0) {
      const distance = calculateDistance(home.lat, home.lon, c.lat, c.lon, unitsVal);
      if (distance > radiusVal) return false;
    }
    
    return true;
  });

  // Draw radius circle if home and radius are set
  if (home && radiusVal > 0) {
    const radiusMeters = radiusVal * (unitsVal === 'mi' ? 1609.34 : 1000);
    L.circle([home.lat, home.lon], {
      radius: radiusMeters,
      color: '#2563eb',
      fillColor: '#2563eb',
      fillOpacity: 0.1,
      weight: 2,
      dashArray: '5, 5'
    }).addTo(radiusLayer);
  }

  console.log(`Rendering ${filtered.length} colleges`);
  
  filtered.forEach(c => {
    try {
      // Validate coordinates
      if (isNaN(c.lat) || isNaN(c.lon) || c.lat === 0 || c.lon === 0) {
        console.warn(`Invalid coordinates for ${c.name}:`, c.lat, c.lon);
        return;
      }
      
      const tuition = c.tuition ? (c.tuition.toString().includes('$') ? c.tuition : `$${Number(c.tuition).toLocaleString()}`) : 'N/A';
      const acceptance = c.acceptance ? (c.acceptance.toString().includes('%') ? c.acceptance : `${parseFloat(c.acceptance).toFixed(1)}%`) : 'N/A';
      
      // Calculate distance if home is set
      let distanceText = '';
      if (home) {
        const distance = calculateDistance(home.lat, home.lon, c.lat, c.lon, unitsVal);
        distanceText = `<br>Distance: ${distance.toFixed(1)} ${unitsVal}`;
      }
      
      const popupContent = `
        <div style="font-size:12px;line-height:1.4">
          <b>${c.name}</b><br>
          ${c.state} · ${(c.type||'Unknown')}${distanceText}<br>
          ${c.control ? c.control + ' | ' : ''}Acceptance Rate: ${acceptance}<br>
          Enrollment: ${c.enrollment || 'N/A'}<br>
          Tuition: ${tuition}<br>
          ${c.url ? `<a href="https://${c.url.replace(/^https?:\/\//,'')}" target="_blank">${c.url}</a>` : ''}
        </div>`;

    L.circleMarker([c.lat, c.lon], {radius: 5, color: '#2563eb', weight: 2, fillOpacity: 0.7})
      .bindTooltip(c.name, {permanent: false, direction: 'top'})
      .bindPopup(popupContent)
      .addTo(markersLayer);
    } catch (e) {
      console.error(`Error creating marker for ${c.name}:`, e);
    }
  });

  elements.count.textContent = filtered.length.toLocaleString();
  console.log(`Added ${filtered.length} markers to map`);
}

function refreshDropdown(id, values, placeholder) {
  const select = document.getElementById(id);
  select.innerHTML = `<option value="">${placeholder}</option>` + values.map(v => `<option>${v}</option>`).join('');
}

function loadCSV(url){
  elements.loading.classList.add('active');
  
  // Try to load from cache first
  const cacheKey = 'colleges_data_cache';
  const cacheTime = 'colleges_data_time';
  const cacheExpiry = 24 * 60 * 60 * 1000; // 24 hours
  
  try {
    const cachedData = localStorage.getItem(cacheKey);
    const cachedTime = localStorage.getItem(cacheTime);
    
    if (cachedData && cachedTime && Date.now() - parseInt(cachedTime) < cacheExpiry) {
      const data = JSON.parse(cachedData);
      processCollegesData(data);
      elements.loading.classList.remove('active');
      return;
    }
  } catch (e) {
    // Cache read failed, proceed with download
  }
  
  Papa.parse(url, {
    header: true,
    dynamicTyping: true,
    download: true,
    complete: (results) => {
      elements.loading.classList.remove('active');
      
      console.log('CSV parsing complete. Rows:', results.data?.length);
      
      if (results.errors && results.errors.length > 0) {
        console.warn('CSV parsing errors:', results.errors);
      }
      
      if (!results.data || results.data.length === 0) {
        showError('Failed to load colleges data. Please refresh the page.');
        console.error('No data in CSV results');
        return;
      }
      
      // Cache the data
      try {
        localStorage.setItem(cacheKey, JSON.stringify(results.data));
        localStorage.setItem(cacheTime, Date.now().toString());
        console.log('Data cached successfully');
      } catch (e) {
        console.warn('Cache write failed:', e);
      }
      
      processCollegesData(results.data);
    },
    error: (error) => {
      elements.loading.classList.remove('active');
      showError('Error loading colleges data: ' + (error.message || 'Unknown error'));
      console.error('CSV load error:', error);
    }
  });
}

function processCollegesData(data) {
  colleges = data.filter(r => r.name && r.lat && r.lon).map(r => ({
    name: r.name,
    lat: +r.lat,
    lon: +r.lon,
    state: (r.state || '').toUpperCase(),
    type: r.type || 'Unknown',
    control: r.control || '',
    acceptance: r.acceptance || '',
    enrollment: r.enrollment || '',
    tuition: r.tuition || '',
    url: r.url || ''
  }));
  
  console.log(`Loaded ${colleges.length} colleges`);
  
  if (colleges.length === 0) {
    showError('No college data found. Please check the CSV file.');
    return;
  }
  
  const states = [...new Set(colleges.map(c => c.state))].sort();
  const types = [...new Set(colleges.map(c => c.type))].filter(Boolean);
  const ranked = [...TYPE_ORDER.filter(t => types.includes(t))];
  const leftovers = types.filter(t => !TYPE_ORDER.includes(t)).sort();
  const orderedTypes = ranked.concat(leftovers);
  
  refreshDropdown('state', states, 'All');
  refreshDropdown('type', orderedTypes, 'Any');
  refreshDropdown('region', ['Northeast', 'Midwest', 'South', 'West', 'Territories'], 'All');
  
  render();
}

function geocodeAddress(address){
  if(!address) {
    showError('Please enter an address');
    return;
  }
  
  closeAutocomplete();
  elements.loading.classList.add('active');
  
  // Rate limiting: Nominatim requires a User-Agent and has strict rate limits
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`, {
    headers: {
      'User-Agent': 'USCollegeMap/1.0'
    }
  })
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      elements.loading.classList.remove('active');
      
      if (data && data[0]) {
        const lat = +data[0].lat;
        const lon = +data[0].lon;
        home = { lat, lon };
        homeLayer.clearLayers();
        radiusLayer.clearLayers();
        L.marker([lat, lon], { icon: L.icon({
          iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="25" height="35" viewBox="0 0 12 18"><path fill="#dc2626" d="M6 0C2.69 0 0 2.69 0 6c0 5 6 12 6 12s6-7 6-12c0-3.31-2.69-6-6-6zm0 8.5c-1.38 0-2.5-1.12-2.5-2.5S4.62 3.5 6 3.5 8.5 4.62 8.5 6 7.38 8.5 6 8.5z"/></svg>'),
          iconSize: [25, 35],
          iconAnchor: [12, 35],
          popupAnchor: [0, -35]
        })})
          .bindPopup("Home location")
          .addTo(homeLayer)
          .openPopup();
        map.setView([lat, lon], 8);
        render(); // Re-render to apply radius filter
      } else {
        showError('Address not found. Please try a different address.');
      }
    })
    .catch(error => {
      elements.loading.classList.remove('active');
      showError('Error geocoding address: ' + (error.message || 'Please try again later'));
      console.error('Geocoding error:', error);
    });
}

// Address autocomplete functions
function searchAddresses(query) {
  if (!query || query.length < 3) {
    closeAutocomplete();
    return;
  }
  
  // Cancel previous request if any
  if (addressAutocomplete.abortController) {
    addressAutocomplete.abortController.abort();
  }
  
  // Show loading state
  addressAutocomplete.suggestions = [];
  addressAutocomplete.selectedIndex = -1;
  elements.addressSuggestions.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
  elements.addressSuggestions.classList.add('active');
  addressAutocomplete.isOpen = true;
  
  // Create new abort controller
  addressAutocomplete.abortController = new AbortController();
  
  // Rate limiting: Nominatim requires a User-Agent and has strict rate limits (1 request per second)
  // URL encoding prevents XSS and handles special characters
  const sanitizedQuery = query.trim().substring(0, 200); // Limit query length
  
  // Enhanced search - get more results to filter and rank better
  // Request more results to ensure we have enough to show 5 unique ones
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(sanitizedQuery)}&limit=20&addressdetails=1&countrycodes=us&dedupe=0&extratags=1`, {
    headers: {
      'User-Agent': 'USCollegeMap/1.0'
    },
    signal: addressAutocomplete.abortController.signal
  })
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      if (!data || data.length === 0) {
        addressAutocomplete.suggestions = [];
        renderSuggestions();
        return;
      }
      
      // Filter and rank results like Google Maps
      const results = data.map(item => {
        const displayName = item.display_name || '';
        const queryLower = query.toLowerCase().trim();
        const nameLower = displayName.toLowerCase();
        
        // Calculate relevance score
        let score = 0;
        
        // Exact start match gets highest score
        if (nameLower.startsWith(queryLower)) {
          score += 100;
        }
        // Contains query
        else if (nameLower.includes(queryLower)) {
          score += 50;
        }
        // Word boundary matches
        const queryWords = queryLower.split(/\s+/).filter(w => w.length > 0);
        const nameWords = nameLower.split(/[,\s]+/).filter(w => w.length > 0);
        const matchingWords = queryWords.filter(qw => nameWords.some(nw => nw.startsWith(qw) || nw.includes(qw)));
        score += matchingWords.length * 10;
        
        // Prefer places with higher importance (if available)
        if (item.importance) {
          score += item.importance * 5;
        }
        
        // Prefer more specific addresses (addresses with numbers)
        if (/\d/.test(displayName)) {
          score += 5;
        }
        
        // Base score for any result (so all results are included)
        score += 1;
        
        return {
          ...item,
          relevanceScore: score,
          matchedQuery: query
        };
      });
      
      // Sort by relevance score (highest first)
      results.sort((a, b) => b.relevanceScore - a.relevanceScore);
      
      // Remove duplicates and take top 5
      const uniqueResults = [];
      const seenNames = new Set();
      
      for (const result of results) {
        // Use a more lenient duplicate check - just the first 50 chars
        const nameKey = result.display_name.toLowerCase().substring(0, 50).trim();
        if (seenNames.has(nameKey) || nameKey.length === 0) {
          continue;
        }
        seenNames.add(nameKey);
        uniqueResults.push(result);
        
        // Stop when we have 5 unique results
        if (uniqueResults.length >= 5) {
          break;
        }
      }
      
      // Always show up to 5 results (prioritize unique, but show all if we have fewer)
      // If we don't have 5 unique, fill with remaining results
      if (uniqueResults.length < 5 && results.length > uniqueResults.length) {
        const remaining = results.filter(r => {
          const key = r.display_name.toLowerCase().substring(0, 50).trim();
          return !seenNames.has(key);
        });
        uniqueResults.push(...remaining.slice(0, 5 - uniqueResults.length));
      }
      
      addressAutocomplete.suggestions = uniqueResults.slice(0, 5);
      renderSuggestions();
    })
    .catch(error => {
      if (error.name === 'AbortError') {
        return; // Request was cancelled, ignore
      }
      console.error('Autocomplete error:', error);
      elements.addressSuggestions.innerHTML = '<div class="autocomplete-empty" style="color:#d93025;">Unable to load suggestions. Please try again.</div>';
    });
}

function formatAddressName(displayName, query = '') {
  // Clean up the display name - remove awkward commas after street numbers
  let cleanedName = displayName.replace(/(\d+),\s+/g, '$1 '); // "25, " becomes "25 "
  
  const parts = cleanedName.split(',').map(p => p.trim()).filter(p => p);
  let primary, secondary;
  
  // Format like Google Maps: primary address on first line, location details on second
  if (parts.length >= 3) {
    // Full address: "Street Address, City, State, Country"
    // Primary: Street Address (first part)
    // Secondary: City, State, Country (remaining parts)
    primary = parts[0];
    secondary = parts.slice(1).join(', ');
  } else if (parts.length === 2) {
    // Two parts: check if first is just a number
    if (/^\d+$/.test(parts[0])) {
      // If "25, Location" -> combine to "25 Location"
      primary = parts.join(' ');
      secondary = '';
    } else {
      // "Street, City" -> Primary: Street, Secondary: City
      primary = parts[0];
      secondary = parts[1];
    }
  } else {
    // Single part
    primary = cleanedName;
    secondary = '';
  }
  
  // Escape HTML first, then apply highlighting
  // This is simpler and safer - we'll find matches in escaped text
  const escapeHtml = (text) => text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  
  // Escape the text first
  let escapedPrimary = escapeHtml(primary);
  secondary = escapeHtml(secondary);
  
  // Now apply highlighting on the escaped text
  if (query && query.length >= 2) {
    const queryLower = query.toLowerCase().trim();
    const escapedQueryLower = escapeHtml(query).toLowerCase();
    const escapedPrimaryLower = escapedPrimary.toLowerCase();
    const matchIndex = escapedPrimaryLower.indexOf(escapedQueryLower);
    
    if (matchIndex !== -1) {
      const before = escapedPrimary.substring(0, matchIndex);
      const match = escapedPrimary.substring(matchIndex, matchIndex + escapeHtml(query).length);
      const after = escapedPrimary.substring(matchIndex + escapeHtml(query).length);
      escapedPrimary = `${before}<strong>${match}</strong>${after}`;
    }
  }
  
  primary = escapedPrimary;
  
  return { primary, secondary };
}

function getAddressTypeIcon(type) {
  // Determine icon based on address type
  const icons = {
    'place': '<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>',
    'house': '<path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>',
    'default': '<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>'
  };
  
  const addressType = (type || '').toLowerCase();
  if (addressType.includes('house') || addressType.includes('building') || addressType.includes('residential')) {
    return icons.house;
  }
  if (addressType.includes('place') || addressType.includes('point')) {
    return icons.place;
  }
  return icons.default;
}

function renderSuggestions() {
  if (addressAutocomplete.suggestions.length === 0) {
    elements.addressSuggestions.innerHTML = '<div class="autocomplete-empty" role="option">No suggestions found</div>';
    return;
  }
  
  const html = addressAutocomplete.suggestions.map((item, index) => {
    const isSelected = index === addressAutocomplete.selectedIndex;
    const query = item.matchedQuery || '';
    const formatted = formatAddressName(item.display_name, query);
    
    // formatAddressName already escapes HTML and handles <strong> tags
    const safePrimary = formatted.primary;
    const safeSecondary = formatted.secondary;
    const safeFullName = item.display_name.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/&/g, '&amp;');
    
    // Get icon based on address type
    const addressType = item.type || item.class || 'place';
    const iconPath = getAddressTypeIcon(addressType);
    
    return `
      <div class="autocomplete-item ${isSelected ? 'highlighted' : ''}" 
           role="option"
           id="suggestion-${index}"
           aria-selected="${isSelected}"
           tabindex="${isSelected ? '0' : '-1'}"
           data-index="${index}"
           data-lat="${item.lat}"
           data-lon="${item.lon}"
           data-name="${safeFullName}">
        <div class="autocomplete-item-icon">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            ${iconPath}
          </svg>
        </div>
        <div class="autocomplete-item-content">
          <div class="address-name">${safePrimary}</div>
          ${safeSecondary ? `<div class="address-details">${safeSecondary}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  elements.addressSuggestions.innerHTML = html;
  elements.address.setAttribute('aria-expanded', 'true');
  
  // Add click handlers
  elements.addressSuggestions.querySelectorAll('.autocomplete-item').forEach((item, index) => {
    item.addEventListener('click', () => selectSuggestion(index));
    item.addEventListener('mouseenter', () => {
      addressAutocomplete.selectedIndex = index;
      renderSuggestions();
    });
  });
}

function selectSuggestion(index) {
  if (!addressAutocomplete.suggestions[index]) return;
  
  const suggestion = addressAutocomplete.suggestions[index];
  elements.address.value = suggestion.display_name;
  closeAutocomplete();
  elements.address.focus(); // Return focus to input for accessibility
  geocodeAddress(suggestion.display_name);
}

function closeAutocomplete() {
  elements.addressSuggestions.classList.remove('active');
  elements.address.setAttribute('aria-expanded', 'false');
  addressAutocomplete.isOpen = false;
  addressAutocomplete.selectedIndex = -1;
}

function handleAutocompleteKeydown(e) {
  if (!addressAutocomplete.isOpen || addressAutocomplete.suggestions.length === 0) {
    if (e.key === 'Enter') {
      e.preventDefault();
      geocodeAddress(elements.address.value);
    }
    return;
  }
  
  switch(e.key) {
    case 'ArrowDown':
      e.preventDefault();
      addressAutocomplete.selectedIndex = Math.min(
        addressAutocomplete.selectedIndex + 1,
        addressAutocomplete.suggestions.length - 1
      );
      renderSuggestions();
      scrollToSelected();
      break;
      
    case 'ArrowUp':
      e.preventDefault();
      addressAutocomplete.selectedIndex = Math.max(addressAutocomplete.selectedIndex - 1, -1);
      renderSuggestions();
      scrollToSelected();
      break;
      
    case 'Enter':
      e.preventDefault();
      if (addressAutocomplete.selectedIndex >= 0) {
        selectSuggestion(addressAutocomplete.selectedIndex);
      } else {
        geocodeAddress(elements.address.value);
      }
      break;
      
    case 'Escape':
      e.preventDefault();
      closeAutocomplete();
      break;
  }
}

function scrollToSelected() {
  const selected = elements.addressSuggestions.querySelector('.autocomplete-item.highlighted');
  if (selected) {
    selected.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  }
}

// Initialize dropdowns immediately
// Region dropdown (doesn't depend on CSV)
refreshDropdown('region', ['Northeast', 'Midwest', 'South', 'West', 'Territories'], 'All');

// Type dropdown (initialize with common types, will be updated when CSV loads)
try {
  refreshDropdown('type', TYPE_ORDER.filter(Boolean), 'Any');
} catch (e) {
  console.error('Error initializing type dropdown:', e);
  // Fallback: ensure dropdown at least exists
  const typeSelect = document.getElementById('type');
  if (typeSelect) {
    typeSelect.innerHTML = '<option value="">Any</option>';
  }
}

// Event listeners
elements.geocodeBtn.onclick = () => geocodeAddress(elements.address.value);

// Address autocomplete
elements.address.addEventListener('input', debounce((e) => {
  searchAddresses(e.target.value);
}, 400));

elements.address.addEventListener('keydown', handleAutocompleteKeydown);

// Close autocomplete when clicking outside
document.addEventListener('click', (e) => {
  if (!elements.address.contains(e.target) && !elements.addressSuggestions.contains(e.target)) {
    closeAutocomplete();
  }
});

elements.clearRadius.onclick = () => {
  elements.radius.value = '50';
  home = null;
  homeLayer.clearLayers();
  radiusLayer.clearLayers();
  map.setView([39.5, -98.35], 4);
  render();
};

['state', 'region', 'type', 'radius', 'units'].forEach(id => {
  document.getElementById(id).addEventListener('change', render);
});

// Debounced search input
elements.search.addEventListener('input', debounce(render, 300));

// Check if running from file:// protocol (won't work due to CORS)
if (window.location.protocol === 'file:') {
  showError('Please use a web server to test this page. CSV files cannot load from file:// protocol. Use: python3 -m http.server 8000');
  console.error('Cannot load CSV from file:// protocol due to CORS restrictions');
} else {
  loadCSV(DATA_URL);
}
</script>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E2KP0JHTMC"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-E2KP0JHTMC');
</script>

</body>
</html>
